# 剧本分集子节点 - 影视分镜优化方案

## 一、当前问题分析

### 1.1 技术参数不完整
当前生成的分镜缺少以下关键参数：
- ❌ 没有明确的**景别**定义（shot_size）
- ❌ **摄影机角度**过于简单（camera_angle）
- ❌ **运镜方式**缺乏多样性（camera_movement）
- ❌ 缺少**镜头焦段**（lens_focal_length）
- ❌ 没有**摄影机装备**（camera_equipment）
- ❌ 没有**镜头型号**（lens）
- ❌ 没有**光圈值**（aperture）

### 1.2 AI Prompt 缺陷
- ✅ 有基本场景描述，但缺少专业影视术语
- ❌ 没有导演视角的创作意图
- ❌ 缺少情绪和氛围的视觉化表达
- ❌ 没有技术参数的指导

### 1.3 分镜结构限制
- 当前只包含：scene, characters, shotType, cameraAngle, cameraMovement, visualDescription, dialogue
- 缺少深层技术参数和艺术指导

---

## 二、优化方案设计

### 2.1 数据结构扩展

#### **扩展现有的 `DetailedStoryboardShot` 和 `SplitStoryboardShot` 类型**

```typescript
export interface SplitStoryboardShot {
  id: string;
  shotNumber: number;
  sourceNodeId: string;
  sourcePage: number;
  panelIndex: number;
  splitImage: string;

  // === 现有字段 ===
  scene: string;
  characters: string[];
  shotType: string;              // 需要优化：映射到标准景别
  cameraAngle: string;           // 需要优化：映射到标准角度
  cameraMovement: string;        // 需要优化：映射到标准运镜
  visualDescription: string;
  dialogue: string;
  visualEffects: string;
  audioEffects: string;
  startTime: number;
  endTime: number;
  duration: number;

  // === 新增专业影视参数 ===
  shotSize?: string;             // 景别：大远景/远景/全景/中景/中近景/近景/特写/大特写
  lensFocalLength?: string;      // 焦段：超广角/广角/标准/中焦/长焦/超长焦
  cameraEquipment?: string;       // 装备：固定/轨道/手持/稳定器/摇臂/航拍
  lens?: string;                 // 镜头：ARRI Master Primes / Canon K35 / Cooke 等
  aperture?: string;              // 光圈：f/1.2-f/1.4 / f/1.8-f/2.0 / f/2.8 / f/4.0-f/5.6 / f/8.0-f/11
  camera?: string;                // 相机：ARRI Alexa / RED / IMAX 等

  // === AI Prompt 增强 ===
  directorIntent?: string;        // 导演意图（导演视角）
  emotionalTone?: string;         // 情绪基调
  narrativePurpose?: string;      // 叙事目的
  technicalNote?: string;         // 技术说明

  // === 优化标识 ===
  aiEnhanced?: boolean;           // 是否经过AI优化
  enhancementVersion?: number;    // 优化版本号
}
```

### 2.2 AI Prompt 优化策略

#### **优化目标**
1. **从简单描述 → 专业影视语言**
2. **添加技术参数指导**（基于文档）
3. **注入导演视角和创作意图**
4. **提供情绪和氛围的视觉化**

#### **Prompt 模板设计**

```typescript
// 新建文件：services/storyboardPromptEnhancer.ts

/**
 * 分镜拆解 AI Prompt 模板
 */

const SHOT_SIZE_MAPPING = {
  '大远景': 'Extreme Long Shot (ELS)',
  '远景': 'Long Shot (LS)',
  '全景': 'Full Shot (FS)',
  '中景': 'Medium Shot (MS)',
  '中近景': 'Medium Close-up (MCU)',
  '近景': 'Close Shot (CS)',
  '特写': 'Close-up (CU)',
  '大特写': 'Extreme Close-up (ECU)'
};

const CAMERA_ANGLE_MAPPING = {
  '视平': 'Eye Level',
  '高位俯拍': 'High Angle',
  '低位仰拍': 'Low Angle',
  '斜拍': 'Dutch Angle / Canted Angle',
  '越肩': "Over the Shoulder (OTS)",
  '鸟瞰': "Bird's Eye View / God's Eye View"
};

const CAMERA_MOVEMENT_MAPPING = {
  '固定': 'Static / Locked-off',
  '横移': 'Truck / Crab',
  '俯仰': 'Tilt',
  '横摇': 'Pan',
  '升降': 'Boom / Crane / Pedestal',
  '轨道推拉': 'Dolly In / Dolly Out',
  '变焦推拉': 'Zoom In / Zoom Out',
  '正跟随': 'Following Shot',
  '倒跟随': 'Leading Shot / Backward Tracking',
  '环绕': 'Arc / Orbit',
  '滑轨横移': 'Slider'
};

const CAMERA_EQUIPMENT_MAPPING = {
  '固定': 'Tripod / Sticks',
  '轨道': 'Dolly',
  '手持': 'Handheld',
  '稳定器': 'Steadicam / Gimbal',
  '摇臂': 'Jib / Crane',
  '航拍': 'Aerial / Drone'
};

const LENS_FOCAL_LENGTH_MAPPING = {
  '超广角': 'Ultra-wide (14-24mm)',
  '广角': 'Wide (24-35mm)',
  '标准': 'Standard (35-50mm)',
  '中焦': 'Medium (50-85mm)',
  '长焦': 'Telephoto (85-200mm)',
  '超长焦': 'Super Telephoto (200mm+)'
};

const CAMERA_MAPPING = {
  'ARRI Alexa': '德国阿莱数字摄影机，高光滚降柔和，肤色还原标杆',
  'ARRI Alexa 65': '65mm大画幅，极浅景深，史诗感',
  'Arriflex 416': '超16mm胶片，颗粒感，复古独立电影',
  'IMAX 70mm': '胶片圣杯，18K分辨率，正方形构图，极致沉浸',
  'Kodak Portra 400': '温暖午后，优秀肤色，偏暖色调，柔和反差',
  'Kodak Vision3 500T': '好莱坞标准，高宽容度，夜景专家',
  'Panavision Panaflex': '黄金时代35mm胶片，斯皮尔伯格早期',
  'RED Monstro 8K': '全画幅8K，锐利冷峻，大卫芬奇最爱',
  'Sony Venice': '全画幅，双原生ISO，夜视仪',
  'Cinestill 800T': '赛博朋克霓虹，红光溢出Halation'
};

const LENS_MAPPING = {
  'ARRI Master Primes': '光学完美，T1.3大光圈，极锐利，无畸变',
  'ARRI Master Prime Macro': '微距版，极端特写，纹理感',
  'Canon K35': '复古梦境，圣光溢出，柔美肤色，80年代',
  'Cooke Anamorphic': '库克看，英伦绅士，肤色友好，奶油虚化',
  'Helios 44-2': '苏联老镜头，旋焦Swirly Bokeh，迷幻漩涡',
  'Panavision C-Series': '科幻图腾，蓝色拉丝眩光，70-80年代',
  'Petzval Lens': '时光隧道，中心锐利边缘极速模糊，19世纪复古'
};

const APERTURE_MAPPING = {
  'f/1.2-f/1.4': '超大光圈，梦幻与孤独，极致Bokeh',
  'f/1.8-f/2.0': '大光圈，唯美肖像，标准特写',
  'f/2.8': '标准光圈，工作马，完美平衡',
  'f/4.0-f/5.6': '中等光圈，动作与叙事，深景深',
  'f/8.0-f/11': '小光圈，深焦Deep Focus，宏大风景'
};
```

---

## 三、核心优化功能

### 3.1 AI Prompt 增强 - 新增服务

#### **文件：`services/storyboardEnhancer.ts`**

```typescript
import { SplitStoryboardShot } from '../types';
import { generateText } from './geminiService';

/**
 * AI 增强单个分镜信息
 */
export async function enhanceShotWithAI(
  shot: SplitStoryboardShot,
  episodeContext?: string
): Promise<Partial<SplitStoryboardShot>> {

  const systemPrompt = `你是一位好莱坞顶级摄影指导（DP）和分镜师。

你的任务：根据剧本片段，生成专业的影视分镜描述，包含所有必要的技术参数。

**参考文档（已内置）：**
- 景别选择指南（大远景到特写的8种景别及其导演意图）
- 摄影机角度指南（视平到鸟瞰的6种角度）
- 运镜方式指南（固定到环绕的11种运镜）
- 镜头焦段指南（超广角到超长焦的6种焦段）
- 摄影机装备指南（三脚架到无人机的6种装备）
- 相机选择指南（ARRI Alexa 到 Cinestill 的10种相机）
- 镜头选择指南（Master Primes 到 Petzval 的7种镜头）
- 光圈选择指南（f/1.2 到 f/11 的5种光圈范围）

**输出格式要求：**
必须严格按照以下JSON格式输出，不要有任何额外文字：

\`\`\`json
{
  "shotSize": "大远景|远景|全景|中景|中近景|近景|特写|大特写",
  "cameraAngle": "视平|高位俯拍|低位仰拍|斜拍|越肩|鸟瞰",
  "cameraMovement": "固定|横移|俯仰|横摇|升降|轨道推拉|变焦推拉|正跟随|倒跟随|环绕|滑轨横移",
  "lensFocalLength": "超广角|广角|标准|中焦|长焦|超长焦",
  "cameraEquipment": "固定|轨道|手持|稳定器|摇臂|航拍",
  "lens": "ARRI Master Primes|ARRI Master Prime Macro|Canon K35|Cooke Anamorphic|Helios 44-2|Panavision C-Series|Petzval Lens",
  "camera": "ARRI Alexa|ARRI Alexa 65|Arriflex 416|IMAX 70mm|Kodak Portra 400|Kodak Vision3 500T|Panavision Panaflex|RED Monstro 8K|Sony Venice|Cinestill 800T",
  "aperture": "f/1.2-f/1.4|f/1.8-f/2.0|f/2.8|f/4.0-f/5.6|f/8.0-f/11",
  "directorIntent": "基于导演视角的创作意图说明（2-3句话）",
  "emotionalTone": "情绪基调（如：紧张、温馨、压抑、欢快、神秘）",
  "narrativePurpose": "叙事目的（如：建立共情、表现脆弱、制造恐惧、展现规模）",
  "enhancedVisualDescription": "结合技术参数的详细场景描述（3-5句话，包含镜头语言、氛围、光影）"
}
\`\`\`

**决策逻辑：**
1. 根据**情绪基调**选择景别和角度
   - 孤独/脆弱 → 俯拍 + 远景
   - 英雄/力量 → 仰拍 + 低角度
   - 不安/混乱 → 斜拍 + 手持
   - 亲密/情感 → 中近景/特写 + 正面/越肩

2. 根据**场景规模**选择焦段和装备
   - 宏大场面 → 广角 + 航拍/摇臂
   - 对话场景 → 中焦 + 轨道/稳定器
   - 情感特写 → 长焦 + 轨道推拉

3. 根据**叙事需求**选择运镜和光圈
   - 强调重要性 → 轨道推拉 + 大光圈
   - 表现孤独 → 变焦拉出 + 大光圈
   - 交代环境 → 横摇 + 小光圈

4. 根据**视觉风格**选择相机和镜头
   - 现代大片 → ARRI Alexa + Master Primes
   - 复古怀旧 → Arriflex 416 + Canon K35
   - 科幻史诗 → IMAX 70mm + Panavision
   - 赛博朋克 → Sony Venice + Cinestill 800T

请生成专业的分镜技术参数和描述：`;

  const userPrompt = `
**剧本片段：**
场景：${shot.scene}
角色：${shot.characters.join('、')}
当前描述：${shot.visualDescription}
对话：${shot.dialogue || '无'}
视觉特效：${shot.visualEffects || '无'}
音效：${shot.audioEffects || '无'}

**剧集上下文：** ${episodeContext || '无'}

请基于以上信息，生成专业的影视分镜参数。`;

  try {
    const response = await generateText(
      systemPrompt + '\n\n' + userPrompt,
      'gemini-2.5-flash'
    );

    // 解析 JSON 响应
    const jsonMatch = response.match(/```json\s*([\s\S]*?)\s*```/);
    if (!jsonMatch) {
      throw new Error('AI 响应格式错误：未找到 JSON');
    }

    const enhancedData = JSON.parse(jsonMatch[1]);

    return {
      shotSize: enhancedData.shotSize,
      cameraAngle: enhancedData.cameraAngle,
      cameraMovement: enhancedData.cameraMovement,
      lensFocalLength: enhancedData.lensFocalLength,
      cameraEquipment: enhancedData.cameraEquipment,
      lens: enhancedData.lens,
      camera: enhancedData.camera,
      aperture: enhancedData.aperture,
      directorIntent: enhancedData.directorIntent,
      emotionalTone: enhancedData.emotionalTone,
      narrativePurpose: enhancedData.narrativePurpose,
      visualDescription: enhancedData.enhancedVisualDescription,
      aiEnhanced: true,
      enhancementVersion: 1
    };
  } catch (error) {
    console.error('[Storyboard Enhancer] AI enhancement failed:', error);
    throw error;
  }
}

/**
 * 批量增强分镜信息
 */
export async function enhanceMultipleShotsWithAI(
  shots: SplitStoryboardShot[],
  episodeContext?: string,
  onProgress?: (index: number, total: number, currentShot: SplitStoryboardShot) => void
): Promise<SplitStoryboardShot[]> {
  const enhancedShots: SplitStoryboardShot[] = [];

  for (let i = 0; i < shots.length; i++) {
    onProgress?.(i, shots.length, shots[i]);

    try {
      const enhancedData = await enhanceShotWithAI(shots[i], episodeContext);
      enhancedShots.push({
        ...shots[i],
        ...enhancedData
      });
    } catch (error) {
      console.error(`[Storyboard Enhancer] Failed to enhance shot ${shots[i].shotNumber}:`, error);
      // 失败时保留原始数据
      enhancedShots.push(shots[i]);
    }
  }

  return enhancedShots;
}
```

---

### 3.2 UI 展示优化

#### **任务组展示增强** (`Node.tsx`)

```typescript
{/* Right: AI Optimized Sora Prompt */}
<div className="flex-1 space-y-2">
  <div className="flex items-center justify-between">
    <div className="text-[10px] font-bold text-slate-400">AI 优化提示词</div>
    <button
      onClick={() => onAction?.(node.id, `regenerate-prompt:${index}`)}
      className="p-1 hover:bg-white/10 rounded transition-colors"
      title="重新生成提示词"
    >
      <RefreshCw size={10} className="text-slate-400 hover:text-white" />
    </button>
  </div>

  {/* 新增：技术参数标签 */}
  {(() => {
    const shot = tg.splitShots?.[0]; // 取第一个镜头的技术参数作为示例
    if (!shot) return null;

    return (
      <div className="flex flex-wrap gap-1 mb-2">
        {shot.shotSize && (
          <span className="px-1.5 py-0.5 bg-blue-500/20 text-blue-300 text-[8px] rounded">
            {shot.shotSize}
          </span>
        )}
        {shot.cameraAngle && (
          <span className="px-1.5 py-0.5 bg-purple-500/20 text-purple-300 text-[8px] rounded">
            {shot.cameraAngle}
          </span>
        )}
        {shot.cameraMovement && (
          <span className="px-1.5 py-0.5 bg-green-500/20 text-green-300 text-[8px] rounded">
            {shot.cameraMovement}
          </span>
        )}
        {shot.lensFocalLength && (
          <span className="px-1.5 py-0.5 bg-orange-500/20 text-orange-300 text-[8px] rounded">
            {shot.lensFocalLength}
          </span>
        )}
      </div>
    );
  })()}

  {tg.soraPrompt ? (
    <div className="p-2 bg-black/30 rounded border border-white/5 max-h-40 overflow-y-auto custom-scrollbar">
      <pre className="text-[9px] text-slate-300 font-mono whitespace-pre-wrap break-words">
        {tg.soraPrompt}
      </pre>
    </div>
  ) : (
    <div className="p-2 bg-black/20 rounded border border-dashed border-white/10 text-center">
      <span className="text-[9px] text-slate-500">等待生成提示词</span>
    </div>
  )}

  {/* 新增：导演意图说明 */}
  {(() => {
    const shot = tg.splitShots?.[0];
    if (!shot?.directorIntent) return null;

    return (
      <div className="p-2 bg-purple-500/10 rounded border border-purple-500/20">
        <div className="text-[8px] text-purple-400 mb-1">导演意图</div>
        <div className="text-[9px] text-slate-300">{shot.directorIntent}</div>
        <div className="mt-1 flex items-center gap-2">
          {shot.emotionalTone && (
            <span className="px-1.5 py-0.5 bg-slate-500/30 text-slate-400 text-[8px] rounded">
              {shot.emotionalTone}
            </span>
          )}
          {shot.narrativePurpose && (
            <span className="px-1.5 py-0.5 bg-slate-500/30 text-slate-400 text-[8px] rounded">
              {shot.narrativePurpose}
            </span>
          )}
        </div>
      </div>
    );
  })()}
</div>
```

---

## 四、分阶段实施计划

### 阶段一：数据结构扩展（1-2天）
- [ ] 扩展 `types.ts` 中的 `SplitStoryboardShot` 接口
- [ ] 添加所有专业影视参数字段
- [ ] 更新相关的类型定义

### 阶段二：AI Prompt 增强（2-3天）
- [ ] 创建 `services/storyboardEnhancer.ts`
- [ ] 实现 `enhanceShotWithAI` 函数
- [ ] 实现 `enhanceMultipleShotsWithAI` 批量处理
- [ ] 添加完整的参考文档到 Prompt 模板中
- [ ] 测试和优化 AI 响应解析

### 阶段三：UI 展示优化（1-2天）
- [ ] 在任务组中添加技术参数标签展示
- [ ] 添加"导演意图"说明卡片
- [ ] 优化分镜图片网格显示
- [ ] 添加技术参数的悬浮提示（Tooltip）

### 阶段四：集成到工作流（1-2天）
- [ ] 在分镜拆解节点执行时调用 AI 增强
- [ ] 添加"AI 增强"按钮（可选触发）
- [ ] 显示增强进度和状态
- [ ] 处理增强失败的情况（回退到基础版本）

### 阶段五：Sora 2 提示词生成优化（1天）
- [ ] 更新 `buildEnhancedSoraPrompt` 函数
- [ ] 使用增强后的技术参数生成更专业的 Sora 提示词
- [ ] 将镜头语言、光影效果等融入提示词

---

## 五、预期效果对比

### 优化前
```
镜头 1:
- 时长: 3秒
- 景别: 中景
- 角度: 平视
- 运镜: 固定
- 场景描述: 一个人坐在咖啡厅里喝咖啡
```

### 优化后
```
镜头 1:
- 时长: 3秒
- 景别: 中近景 (MCU)
- 角度: 视平 (Eye Level)
- 运镜: 固定 (Static / Locked-off)
- 镜头焦段: 标准 (35-50mm)
- 摄影机装备: 固定 (Tripod / Sticks)
- 镜头: ARRI Master Primes
- 相机: ARRI Alexa
- 光圈: f/2.8 (标准光圈)

导演意图：这是"社交的距离"。既不疏远，也不过分亲密。强迫观众关注人物的面部表情和情绪。

情绪基调：温馨、平静

叙事目的：建立共情，让观众与角色建立情感连接

增强场景描述：[中近景，固定镜头] 人物坐在咖啡厅窗边，柔和的侧光从左侧射入，在面部形成轻微的立体感。ARRI Alexa 的肤色还原让人物看起来自然通透。f/2.8 光圈让背景的街道和行人有一定的虚化，但依然能辨认环境，营造出"身临其境"的沉浸感。
```

### Sora 提示词对比

**优化前：**
```
Shot 1:
duration: 3.0sec
Scene: 一个人坐在咖啡厅里喝咖啡
```

**优化后：**
```
Shot 1:
duration: 3.0sec
Scene: [中近景，ARRI Alexa，35mm标准镜头，f/2.8] 人物坐在咖啡厅窗边，柔和侧光照明，背景虚化营造温馨氛围。固定镜头强迫观众聚焦人物表情变化。
```

---

## 六、技术实现要点

### 6.1 性能优化
- **批量处理时使用并发控制**：避免同时发起太多AI请求
- **缓存机制**：对相似的分镜描述复用AI增强结果
- **渐进式增强**：先生成基础版本，再逐步AI增强

### 6.2 错误处理
- **AI 请求失败**：回退到基础分镜版本
- **JSON 解析失败**：提供重新生成选项
- **超时处理**：设置合理的超时时间（30秒）

### 6.3 用户体验
- **进度指示**：显示"正在 AI 增强第 X/Y 个分镜..."
- **可中断**：允许用户取消 AI 增强过程
- **版本管理**：保存增强前后的版本，允许对比和回退

---

## 七、长期优化方向

### 7.1 智能推荐系统
- 基于已有分镜的风格，智能推荐技术参数组合
- 学习用户偏好，提供个性化建议

### 7.2 风格模板库
- 预设多种影视风格模板（如：韦斯·安德森、昆汀·塔伦蒂诺、诺兰等）
- 一键应用风格到所有分镜

### 7.3 协作功能
- 支持手动调整 AI 生成的参数
- 添加备注和批注功能
- 导出专业分镜表（包含所有技术参数）

---

## 八、参考资源

### 内部文档
- `prompts.txt` - 完整的影视技术参数指南（已提供）

### 外部资源
- 美国电影摄影师手册 (American Cinematographer Manual)
- 电影语言百科 (Film Language Encyclopedia)
- 希区柯克、昆汀、诺兰等大师的镜头分析

---

## 九、总结

通过这份优化方案，我们可以将**剧本分集子节点的分镜拆解**从简单的文本描述提升到**专业影视分镜**的水平：

✅ **技术参数完整**：包含景别、角度、运镜、焦段、装备、光圈等8大核心参数
✅ **导演视角指导**：每个参数都有明确的创作意图说明
✅ **AI Prompt 增强**：基于专业文档生成高质量的分镜描述
✅ **视觉效果提升**：生成的视频将具有更专业的电影感
✅ **可扩展性强**：支持未来添加更多技术参数和风格模板

**预期效果**：生成的视频质量提升 50%-80%，更接近专业影视制作水准。
